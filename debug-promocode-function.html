<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Отладка функции промокодов</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .error { color: red; }
        .success { color: green; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        input { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>Отладка функции промокодов</h1>
    
    <div class="debug-section">
        <h3>1. Проверить тарифы</h3>
        <button id="check-plans">Проверить тарифы</button>
        <div id="plans-result"></div>
    </div>
    
    <div class="debug-section">
        <h3>2. Проверить промокод FREE3MONTHS</h3>
        <button id="check-promocode">Проверить промокод</button>
        <div id="promocode-result"></div>
    </div>
    
    <div class="debug-section">
        <h3>3. Тест функции debug_apply_promocode</h3>
        <input type="text" id="test-promocode" value="FREE3MONTHS" placeholder="Промокод">
        <button id="test-debug-function">Тест debug_apply_promocode</button>
        <div id="debug-result"></div>
    </div>
    
    <div class="debug-section">
        <h3>4. Тест функции debug_apply_promocode_detailed</h3>
        <input type="text" id="test-promocode-3" value="FREE3MONTHS" placeholder="Промокод">
        <button id="test-debug-detailed">Тест debug_apply_promocode_detailed</button>
        <div id="debug-detailed-result"></div>
    </div>
    
    <div class="debug-section">
        <h3>4. Тест функции apply_promocode_with_subscription</h3>
        <input type="text" id="test-promocode-2" value="FREE3MONTHS" placeholder="Промокод">
        <button id="test-apply-function">Тест apply_promocode_with_subscription</button>
        <div id="apply-result"></div>
    </div>

    <script src="../lib/supabase.min.js"></script>
    <script src="config.js"></script>
    <script src="../supabase.js"></script>
    <script>
        // Ждем инициализации Supabase
        const waitForSupabase = () => {
            return new Promise((resolve) => {
                const checkSupabase = () => {
                    if (window.supabaseClient) {
                        resolve(window.supabaseClient);
                    } else {
                        setTimeout(checkSupabase, 100);
                    }
                };
                checkSupabase();
            });
        };
        
        // 1. Проверить тарифы
        document.getElementById('check-plans').addEventListener('click', async () => {
            try {
                const supabase = await waitForSupabase();
                const { data, error } = await supabase.from('plans').select('*').order('duration_months', { ascending: true });
                console.log('Тарифы:', { data, error });
                document.getElementById('plans-result').innerHTML = `<pre>${JSON.stringify({ data, error }, null, 2)}</pre>`;
            } catch (err) {
                document.getElementById('plans-result').innerHTML = `<div class="error">Ошибка: ${err.message}</div>`;
            }
        });
        
        // 2. Проверить промокод
        document.getElementById('check-promocode').addEventListener('click', async () => {
            try {
                const supabase = await waitForSupabase();
                const { data, error } = await supabase.from('promocodes').select('*').eq('code', 'FREE3MONTHS');
                console.log('Промокод FREE3MONTHS:', { data, error });
                document.getElementById('promocode-result').innerHTML = `<pre>${JSON.stringify({ data, error }, null, 2)}</pre>`;
            } catch (err) {
                document.getElementById('promocode-result').innerHTML = `<div class="error">Ошибка: ${err.message}</div>`;
            }
        });
        
        // 3. Тест debug_apply_promocode
        document.getElementById('test-debug-function').addEventListener('click', async () => {
            try {
                const supabase = await waitForSupabase();
                const promocode = document.getElementById('test-promocode').value.trim().toUpperCase();
                
                // Получаем первый тариф
                const { data: plans, error: plansError } = await supabase.from('plans').select('*').neq('duration_months', 0).limit(1);
                
                if (plansError || !plans || plans.length === 0) {
                    throw new Error('Не удалось получить тарифы');
                }
                
                const planId = plans[0].id;
                console.log('Используем тариф:', plans[0]);
                console.log('Plan ID тип:', typeof planId, 'Значение:', planId);
                
                // Получаем пользователя
                const { data: { session } } = await supabase.auth.getSession();
                if (!session || !session.user) {
                    throw new Error('Пользователь не авторизован');
                }
                
                console.log('Пользователь:', session.user.id);
                
                // Тестируем функцию debug_apply_promocode
                const { data, error } = await supabase.rpc('debug_apply_promocode', {
                    promocode_text: promocode,
                    user_uuid: session.user.id,
                    plan_id: planId
                });
                
                console.log('Результат debug_apply_promocode:', { data, error });
                document.getElementById('debug-result').innerHTML = `<pre>${JSON.stringify({ data, error }, null, 2)}</pre>`;
                
            } catch (err) {
                console.error('Ошибка:', err);
                document.getElementById('debug-result').innerHTML = `<div class="error">Ошибка: ${err.message}</div>`;
            }
        });
        
        // 4. Тест debug_apply_promocode_detailed
        document.getElementById('test-debug-detailed').addEventListener('click', async () => {
            try {
                const supabase = await waitForSupabase();
                const promocode = document.getElementById('test-promocode-3').value.trim().toUpperCase();
                
                // Получаем первый тариф
                const { data: plans, error: plansError } = await supabase.from('plans').select('*').neq('duration_months', 0).limit(1);
                
                if (plansError || !plans || plans.length === 0) {
                    throw new Error('Не удалось получить тарифы');
                }
                
                const planId = plans[0].id;
                console.log('Используем тариф:', plans[0]);
                console.log('Plan ID тип:', typeof planId, 'Значение:', planId);
                
                // Получаем пользователя
                const { data: { session } } = await supabase.auth.getSession();
                if (!session || !session.user) {
                    throw new Error('Пользователь не авторизован');
                }
                
                console.log('Пользователь:', session.user.id);
                
                // Тестируем функцию debug_apply_promocode_detailed
                const { data, error } = await supabase.rpc('debug_apply_promocode_detailed', {
                    promocode_text: promocode,
                    user_uuid: session.user.id,
                    plan_id: planId
                });
                
                console.log('Результат debug_apply_promocode_detailed:', { data, error });
                document.getElementById('debug-detailed-result').innerHTML = `<pre>${JSON.stringify({ data, error }, null, 2)}</pre>`;
                
            } catch (err) {
                console.error('Ошибка:', err);
                document.getElementById('debug-detailed-result').innerHTML = `<div class="error">Ошибка: ${err.message}</div>`;
            }
        });
        
        // 5. Тест apply_promocode_with_subscription
        document.getElementById('test-apply-function').addEventListener('click', async () => {
            try {
                const supabase = await waitForSupabase();
                const promocode = document.getElementById('test-promocode-2').value.trim().toUpperCase();
                
                // Получаем первый тариф
                const { data: plans, error: plansError } = await supabase.from('plans').select('*').neq('duration_months', 0).limit(1);
                
                if (plansError || !plans || plans.length === 0) {
                    throw new Error('Не удалось получить тарифы');
                }
                
                const planId = plans[0].id;
                console.log('Используем тариф:', plans[0]);
                console.log('Plan ID тип:', typeof planId, 'Значение:', planId);
                
                // Получаем пользователя
                const { data: { session } } = await supabase.auth.getSession();
                if (!session || !session.user) {
                    throw new Error('Пользователь не авторизован');
                }
                
                console.log('Пользователь:', session.user.id);
                
                // Тестируем функцию apply_promocode_with_subscription
                const { data, error } = await supabase.rpc('apply_promocode_with_subscription', {
                    promocode_text: promocode,
                    user_uuid: session.user.id,
                    plan_id: planId
                });
                
                console.log('Результат apply_promocode_with_subscription:', { data, error });
                document.getElementById('apply-result').innerHTML = `<pre>${JSON.stringify({ data, error }, null, 2)}</pre>`;
                
            } catch (err) {
                console.error('Ошибка:', err);
                document.getElementById('apply-result').innerHTML = `<div class="error">Ошибка: ${err.message}</div>`;
            }
        });
    </script>
</body>
</html>
